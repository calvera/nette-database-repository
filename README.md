# Nette Database Repository

Nette Database is a library that enhances the functionality of the popular Nette/Database package by adding support for typed
entities, queries (Selections) and repositories. It provides a convenient way to define and work with strongly-typed entities in your
database-driven applications. This extension aims to improve code readability, maintainability, and reduce the risk of errors related to
data types.

## Installation

The best way to install this extension is using [Composer](http://getcomposer.org/):

```sh
$ composer require nette-database-repository/core
```

Register our configuration:
```neon
includes:
    - %appDir%/../vendor/nette-database-repository/core/config.neon
```

Execute our repository code generation command:
```sh
$ php bin/console repository:code-gen
```

## Usage

### Entity

The `Entity` class extends `ActiveRow` but is made to be used as a base class for your entities. 
It is supposed to be generated by our code generation tool, but you can also write it manually.

#### Inserting an entity

```php
assert($repository instanceof PersonRepository);
assert($entity instanceof Person);
$entity = $repository->createRow();
$entity->name = 'John';
$entity->surname = 'Doe';
$entity->age = 42;
$entity->save();
```

Classic:
```php
$person = $repository->insert([
    Person::name => 'John',
    Person::surname => 'Doe',
    Person::age => 42,
]);
```

Multi-insert:
```php
$persons = [];
foreach (range(30, 40) as $age) {
    $person = $repository->createRow();
    $person->name = 'John';
    $person->surname = 'Doe';
    $person->age = $age;
    $persons[] = $person;
}
$repository->insert($persons);
```

#### Updating an entity

```php
$entity = $repository->find($id);
$entity->name = 'Jake';
$entity->save();
```

Classic:
```php
$repository->update($id, [
    Person::name => 'Jake',
]);
```

#### Deleting an entity

```php
$entity = $repository->find($id);
$entity->delete();
```

Or:
```php
$repository->delete($id);
```
### Scopes
Scope is a way to define which behaviors are enabled for repository, query and entity recursively.

Recursively means, that if you define a scope for repository, it will be applied to query and entity as well.

#### Example
```php
class AdminScope implements \Efabrica\NetteRepository\Repository\Scope\Scope
{
    public function apply(RepositoryBehaviors $behaviors, Repository $repository): void
    {
        $behaviors
            ->remove(SoftDeleteBehavior::class)
            ->remove(PublishBehavior::class);
        // You should only remove behaviors, as the scope can be applied on different repositories at once.
        
        // If you had a user repository and injected the user into the scope, you could do this:
        if ($repository instanceof UserRepository && $this->user->isAdmin()) {
            $behaviors->add(AdminBehavior::class); // This behavior does not exist, it's just an example.
        }
    }
}
```

You should then create your own ScopeContainer:
```php
class AppScopeContainer extends \Efabrica\NetteRepository\Repository\Scope\ScopeContainer
{
    public function __construct(
        FullScope $scope,
        AdminScope $adminScope
    ) {
        parent::__construct($scope);
        $this->adminScope = $adminScope;
    }
    
    public function admin(): self
    {
        return $this->withScope($this->adminScope);
    }
}
```

And implement shorthand methods for your queries:
```php
class QueryBase extends \Efabrica\NetteRepository\Repository\Query
{
    public function scopeAdmin(): self
    {
        $scope = $this->getScope();
        assert($scope instanceof AppScopeContainer);
        return $this->setScope($this->scopeContainer->admin());
    }
}
```

## Code Generator

Code generation is fully optional, but it is recommended to use it. 

For every table in the database, it will generate these classes: (Example: `person` table)
- `Repository\Generated\Repository\PersonRepositoryBase` - Repository base class, holds typehints for `PersonQuery` and `Person` entity. (abstract)
- `Repository\Generated\Query\PersonQuery` - Query class, holds typehints for `Person` entity. (abstract)
- `Repository\Generated\Entity\Person` - Entity class, holds types for columns and public constants for column names. (final)

These classes are generated only if they don't exist. If they exist, they will not be overwritten:
- `Repository\PersonRepository` - extends `PersonRepositoryBase`. Here you write your custom repository methods. (final)
- `Repository\Query\PersonQuery` - extends `PersonQuery`. Here you write your custom query methods. (final)
- `Repository\Entity\PersonBody` - trait that is inserted into `Person` entity. Here you write your custom entity methods. (trait)

### Traits (Behaviors and Event Subscribers)

#### DateBehavior
DateBehavior ensures that the `created_at` and `updated_at` columns are automatically filled with the current date and time on insert and update.

#### KeepDefaultBehavior
KeepDefaultBehavior ensures that there is at least one truthy value in the default column. It is useful for columns that are used as flags.

#### SoftDeleteBehavior
SoftDeleteBehavior ensures that the `deleted_at` column is automatically filled with the current date and time on delete.

#### LastManStandingBehavior
LastManStandingBehavior ensures that there is at least one row in the table for the specified query.

#### TreeTraverseBehavior
TreeTraverseBehavior ensures that the `lft` and `rgt` columns are automatically filled with the correct values on insert and update.

#### SortingTrait
SortingTrait adds moveUp(), moveDown(), insertBefore(), insertAfter() methods to the repository.
